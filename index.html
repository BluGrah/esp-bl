<!DOCTYPE html>
<html>
<head>
    <title>BC660K Flash-First Provisioner</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f0f2f5; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        button { width: 100%; padding: 14px; margin: 8px 0; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        .btn-blue { background: #007aff; color: white; }
        .btn-green { background: #34c759; color: white; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #log { background: #1c1c1e; color: #32d74b; padding: 12px; font-family: monospace; height: 180px; overflow-y: auto; font-size: 12px; border-radius: 8px; }
    </style>
</head>
<body>

<div class="card">
    <h3>1. Connection</h3>
    <button class="btn-blue" onclick="connect()">Connect Bluetooth</button>
</div>

<div class="card">
    <h3>2. Action Menu</h3>
    <button id="btnESP" class="btn-blue" disabled onclick="transferToFlash()">Step 1: Transfer to ESP Flash</button>
    <button id="btnModem" class="btn-green" disabled onclick="writeToModem()">Step 2: Write to Modem</button>
</div>

<div id="log">Log: Ready...</div>

<script>
    let bleChar;
    let files = {};
    const SURL = "https://script.google.com/macros/s/AKfycbw1guunYp2mZ5mEEsAvjMEbbBXs8u0ZoTZaXf6_zFnQceF0BFi3YL09KCuPyDulkTJU/exec";

    function log(m) { 
        const l=document.getElementById('log'); 
        l.innerHTML += "> " + m + "<br>"; 
        l.scrollTop = l.scrollHeight; 
    }

    async function connect() {
        try {
            const dev = await navigator.bluetooth.requestDevice({filters: [{services: ["4fafc201-1fb5-459e-8fcc-c5c9c331914b"]}]});
            const gatt = await dev.gatt.connect();
            const svc = await gatt.getPrimaryService("4fafc201-1fb5-459e-8fcc-c5c9c331914b");
            bleChar = await svc.getCharacteristic("beb5483e-36e1-4688-b7f5-ea07361b26a8");
            
            await bleChar.startNotifications();
            bleChar.addEventListener('characteristicvaluechanged', (e) => {
                log("ESP: " + new TextDecoder().decode(e.target.value));
            });

            log("Bluetooth Connected ✅");
            document.getElementById('btnESP').disabled = false;
            fetchData();
        } catch(e) { log("Conn Error: " + e); }
    }

    async function fetchData() {
        log("Downloading certificates from Drive...");
        // Ensure you replace YOUR_ID or pass it dynamically
        const res = await fetch(SURL + "?action=getCerts&id=STATION_ID_HERE"); 
        files = await res.json();
        log("Files downloaded to browser memory.");
    }

    async function transferToFlash() {
        const queue = [
            {n: "cacert", d: atob(files.ca.data)},
            {n: "clientcert", d: atob(files.cert.data)},
            {n: "clientkey", d: atob(files.key.data)}
        ];

        for (const item of queue) {
            log("Sending " + item.n + " to ESP Flash...");
            await bleChar.writeValue(new TextEncoder().encode("S" + item.n));
            const size = 150;
            for (let i = 0; i < item.d.length; i += size) {
                await bleChar.writeValue(new TextEncoder().encode("D" + item.d.slice(i, i + size)));
                await new Promise(r => setTimeout(r, 60));
            }
            await bleChar.writeValue(new TextEncoder().encode("E"));
            await new Promise(r => setTimeout(r, 1000)); 
        }
        log("✅ STEP 1 COMPLETE: Files are in ESP Flash.");
        document.getElementById('btnModem').disabled = false;
    }

    async function writeToModem() {
        const certs = ["cacert", "clientcert", "clientkey"];
        for (const c of certs) {
            log("Commanding write to Modem: " + c);
            await bleChar.writeValue(new TextEncoder().encode("W" + c));
            // We wait for the MODEM_OK notification or timeout
            await new Promise(r => setTimeout(r, 10000)); 
        }
        log("✅ STEP 2 COMPLETE: Modem provisioning finished.");
    }
</script>
</body>
</html>
