<!DOCTYPE html>
<html>
<head>
    <title>BC660K Provisioner v3</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f9; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        button { width: 100%; padding: 15px; margin: 10px 0; font-weight: bold; border-radius: 5px; border: none; cursor: pointer; }
        .btn-esp { background: #007aff; color: white; }
        .btn-modem { background: #34a853; color: white; }
        button:disabled { background: #ccc; }
        #log { background: #222; color: #0f0; padding: 10px; font-family: monospace; height: 150px; overflow-y: auto; font-size: 12px; border-radius: 5px; }
    </style>
</head>
<body>

<div class="card">
    <h3>1. Connect</h3>
    <button onclick="connectBLE()" class="btn-esp">Connect ESP32 Bluetooth</button>
</div>

<div class="card">
    <h3>2. Action Menu</h3>
    <button id="btnESP" disabled onclick="transferToESP()" class="btn-esp">Step 1: Transfer to ESP Buffer</button>
    <button id="btnModem" disabled onclick="writeToModem()" class="btn-modem">Step 2: Write to Modem NVRAM</button>
</div>

<div id="log">System Ready...</div>

<script>
    let bleChar;
    let files = {};
    const SURL = "https://script.google.com/macros/s/AKfycbw1guunYp2mZ5mEEsAvjMEbbBXs8u0ZoTZaXf6_zFnQceF0BFi3YL09KCuPyDulkTJU/exec";

    function log(m) { const l=document.getElementById('log'); l.innerHTML += "> "+m+"<br>"; l.scrollTop=l.scrollHeight; }

    async function connectBLE() {
        const dev = await navigator.bluetooth.requestDevice({filters:[{services:["4fafc201-1fb5-459e-8fcc-c5c9c331914b"]}]});
        const gatt = await dev.gatt.connect();
        const svc = await gatt.getPrimaryService("4fafc201-1fb5-459e-8fcc-c5c9c331914b");
        bleChar = await svc.getCharacteristic("beb5483e-36e1-4688-b7f5-ea07361b26a8");
        
        await bleChar.startNotifications();
        bleChar.addEventListener('characteristicvaluechanged', (e) => {
            const val = new TextDecoder().decode(e.target.value);
            log("Status: " + val);
        });

        log("Connected to ESP32.");
        document.getElementById('btnESP').disabled = false;
        fetchData();
    }

    async function fetchData() {
        log("Downloading certificates from Drive...");
        const res = await fetch(SURL + "?action=getCerts&id=YOUR_STATION_ID"); // Station ID from previous step
        files = await res.json();
        log("Certificates ready.");
    }

    async function transferToESP() {
        const sequence = [
            {id: "cacert", data: atob(files.ca.data)},
            {id: "clientcert", data: atob(files.cert.data)},
            {id: "clientkey", data: atob(files.key.data)}
        ];

        for (const file of sequence) {
            log("Buffering " + file.id + " to ESP...");
            await bleChar.writeValue(new TextEncoder().encode("S" + file.id));
            const size = 150;
            for (let i = 0; i < file.data.length; i += size) {
                await bleChar.writeValue(new TextEncoder().encode("D" + file.data.slice(i, i + size)));
                await new Promise(r => setTimeout(r, 60));
            }
            await bleChar.writeValue(new TextEncoder().encode("E"));
            await new Promise(r => setTimeout(r, 500)); 
        }
        log("ESP Buffering Complete.");
        document.getElementById('btnModem').disabled = false;
    }

    async function writeToModem() {
        const certs = ["cacert", "clientcert", "clientkey"];
        for (const c of certs) {
            log("Writing to Modem NVRAM: " + c);
            await bleChar.writeValue(new TextEncoder().encode("W" + c));
            await new Promise(r => setTimeout(r, 7000)); // Large delay for modem write
        }
        log("Provisioning Finished.");
    }
</script>
</body>
</html>
