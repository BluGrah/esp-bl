<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Station Provisioner</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f0f2f5; color: #1c1e21; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h3 { margin-top: 0; color: #007aff; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        input, button, select { width: 100%; padding: 14px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; box-sizing: border-box; }
        button { background: #007aff; color: white; border: none; font-weight: bold; cursor: pointer; }
        button:disabled { background: #ccc; }
        select { background-color: #fff; cursor: pointer; }
        .status { padding: 12px; margin: 8px 0; border-radius: 6px; font-size: 14px; background: #f8f9fa; border-left: 4px solid #ccc; }
        .success { border-left-color: #28a745; background: #e9f7ef; color: #155724; }
        .active { border-left-color: #ffc107; background: #fffde7; }
        #debug { font-family: monospace; font-size: 11px; background: #222; color: #0f0; padding: 10px; border-radius: 5px; max-height: 120px; overflow-y: auto; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="card">
        <h3>1. Connection</h3>
        <input type="text" id="scriptUrl" placeholder="Paste Google Script /exec URL here">
        <button id="btnConnect" onclick="connectBLE()">Connect ESP32 Bluetooth</button>
        <p id="bleStatus" style="text-align:center; font-weight:bold;">BLE: Disconnected</p>
    </div>

    <div class="card">
        <h3>2. Select Station</h3>
        <button onclick="fetchAllStations()" style="background: #34a853;">Refresh Station List</button>
        <select id="stationSelect" onchange="onStationChange()">
            <option value="">-- Choose a Station --</option>
        </select>
    </div>

    <div class="card">
        <h3>3. Transfer Status</h3>
        <div id="caStat" class="status">CA Cert: Waiting...</div>
        <div id="certStat" class="status">Client Cert: Waiting...</div>
        <div id="keyStat" class="status">Client Key: Waiting...</div>
        <button id="btnUpdate" disabled onclick="triggerModemUpdate()">Write to Modem Memory</button>
        <div id="debug">System Ready...</div>
    </div>

    <script>
        let bleChar;
        const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
        const CHAR_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";

        function log(msg) {
            const d = document.getElementById('debug');
            d.innerHTML += `<br>> ${msg}`;
            d.scrollTop = d.scrollHeight;
        }

        async function connectBLE() {
            try {
                log("Requesting ESP32...");
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [SERVICE_UUID] }]
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                bleChar = await service.getCharacteristic(CHAR_UUID);
                document.getElementById('bleStatus').innerText = "BLE: Connected ✅";
                document.getElementById('bleStatus').style.color = "green";
                log("Bluetooth Linked.");
            } catch (e) { log("BLE Error: " + e); }
        }

        async function fetchAllStations() {
            const url = document.getElementById('scriptUrl').value;
            if(!url) { alert("Please paste the Script URL first!"); return; }
            log("Fetching station list...");
            
            try {
                const response = await fetch(`${url}?action=listAllFolders`);
                const stations = await response.json();
                const select = document.getElementById('stationSelect');
                
                select.innerHTML = '<option value="">-- Choose a Station --</option>';
                stations.forEach(s => {
                    let opt = document.createElement('option');
                    opt.value = s.id;
                    opt.innerText = s.name;
                    select.appendChild(opt);
                });
                log("List updated. Found " + stations.length + " stations.");
            } catch (e) { log("Fetch Error: " + e); }
        }

        async function onStationChange() {
            const select = document.getElementById('stationSelect');
            const folderId = select.value;
            const folderName = select.options[select.selectedIndex].text;
            
            if(!folderId) return;
            if(!bleChar) { 
                alert("Please connect Bluetooth first!"); 
                select.value = ""; 
                return; 
            }

            log("Preparing " + folderName + "...");
            const url = document.getElementById('scriptUrl').value;

            try {
                const response = await fetch(`${url}?action=getCerts&id=${folderId}`);
                const certs = await response.json();

                // Reset Statuses
                document.querySelectorAll('.status').forEach(s => s.className = 'status');

                if(certs.ca) await uploadToESP(certs.ca, "root_ca.pem", "caStat");
                if(certs.cert) await uploadToESP(certs.cert, "client_cert.pem", "certStat");
                if(certs.key) await uploadToESP(certs.key, "client_key.pem", "keyStat");

                document.getElementById('btnUpdate').disabled = false;
                log("All files ready for Modem Write.");
            } catch (e) { log("Error: " + e); }
        }

        async function uploadToESP(file, espName, statId) {
            const el = document.getElementById(statId);
            el.className = "status active";
            el.innerText = `Sending ${espName}...`;
            
            const raw = atob(file.data);
            log(`Uploading ${espName} (${raw.length} bytes)`);

            await bleChar.writeValue(new TextEncoder().encode("S" + espName));
            const size = 150;
            for (let i = 0; i < raw.length; i += size) {
                const chunk = "D" + raw.slice(i, i + size);
                await bleChar.writeValue(new TextEncoder().encode(chunk));
                await new Promise(r => setTimeout(r, 65)); 
            }
            await bleChar.writeValue(new TextEncoder().encode("E"));
            el.className = "status success";
            el.innerText = `${espName}: Ready ✅`;
        }

        async function triggerModemUpdate() {
            await bleChar.writeValue(new TextEncoder().encode("U"));
            log("Modem memory write triggered.");
            alert("Update Sequence Started!");
        }
    </script>
</body>
</html>
