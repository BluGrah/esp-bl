<!DOCTYPE html>
<html>
<head>
    <title>BC660K Provisioner (Flash-FS)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f2f5; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        button, select { width: 100%; padding: 14px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; font-weight: bold; }
        button { background: #007aff; color: white; border: none; cursor: pointer; }
        .btn-green { background: #34c759; }
        button:disabled { background: #ccc; }
        #log { background: #1c1c1e; color: #32d74b; padding: 12px; font-family: monospace; height: 180px; overflow-y: auto; font-size: 12px; border-radius: 8px; }
    </style>
</head>
<body>

<div class="card">
    <h3>1. Connection</h3>
    <button onclick="connectBLE()">Connect ESP32 Bluetooth</button>
</div>

<div class="card">
    <h3>2. Select Station</h3>
    <select id="stationSelect"><option>Loading folders...</option></select>
    <button id="btnESP" disabled onclick="transferToFlash()">Step 1: Transfer to ESP Flash</button>
    <button id="btnModem" disabled onclick="writeToModem()">Step 2: Write to Modem</button>
</div>

<div id="log">Status: Idle</div>

<script>
    let bleChar;
    let files = {};
    const SURL = "https://script.google.com/macros/s/AKfycbw1guunYp2mZ5mEEsAvjMEbbBXs8u0ZoTZaXf6_zFnQceF0BFi3YL09KCuPyDulkTJU/exec";

    function log(m) { 
        const l=document.getElementById('log'); 
        l.innerHTML += "> " + m + "<br>"; 
        l.scrollTop = l.scrollHeight; 
    }

    window.onload = async () => {
        try {
            const resp = await fetch(SURL + "?action=listAllFolders");
            const stations = await resp.json();
            const sel = document.getElementById('stationSelect');
            sel.innerHTML = '<option value="">-- Choose Station --</option>';
            stations.forEach(s => { sel.innerHTML += `<option value="${s.id}">${s.name}</option>`; });
            log("Station list loaded from Drive.");
        } catch(e) { log("Error loading folders."); }
    };

    async function connectBLE() {
        try {
            const dev = await navigator.bluetooth.requestDevice({filters: [{services: ["4fafc201-1fb5-459e-8fcc-c5c9c331914b"]}]});
            const gatt = await dev.gatt.connect();
            const svc = await gatt.getPrimaryService("4fafc201-1fb5-459e-8fcc-c5c9c331914b");
            bleChar = await svc.getCharacteristic("beb5483e-36e1-4688-b7f5-ea07361b26a8");
            
            await bleChar.startNotifications();
            bleChar.addEventListener('characteristicvaluechanged', (e) => {
                log("ESP32: " + new TextDecoder().decode(e.target.value));
            });
            log("Connected ✅");
            document.getElementById('btnESP').disabled = false;
        } catch(e) { log("Connection Error."); }
    }

    async function transferToFlash() {
        const id = document.getElementById('stationSelect').value;
        if(!id) { alert("Please select a station"); return; }
        
        log("Downloading files from Google Drive...");
        const res = await fetch(SURL + `?action=getCerts&id=${id}`); 
        files = await res.json();

        const queue = [
            {n: "cacert", d: atob(files.ca.data)},
            {n: "clientcert", d: atob(files.cert.data)},
            {n: "clientkey", d: atob(files.key.data)}
        ];

        for (const item of queue) {
            log("Writing " + item.n + " to ESP Flash...");
            await bleChar.writeValue(new TextEncoder().encode("S" + item.n));
            const size = 150;
            for (let i = 0; i < item.d.length; i += size) {
                await bleChar.writeValue(new TextEncoder().encode("D" + item.d.slice(i, i + size)));
                await new Promise(r => setTimeout(r, 60));
            }
            await bleChar.writeValue(new TextEncoder().encode("E"));
            await new Promise(r => setTimeout(r, 1000)); 
        }
        log("✅ Step 1 Complete: Data saved in Flash.");
        document.getElementById('btnModem').disabled = false;
    }

    async function writeToModem() {
        const certs = ["cacert", "clientcert", "clientkey"];
        for (const c of certs) {
            log("Writing to Modem: " + c);
            await bleChar.writeValue(new TextEncoder().encode("W" + c));
            await new Promise(r => setTimeout(r, 9000)); 
        }
        log("✅ Step 2 Complete: Provisioning finished.");
    }
</script>
</body>
</html>
