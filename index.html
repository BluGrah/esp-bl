<!DOCTYPE html>
<html>
<head>
    <title>Azure IoT BC660K Provisioner</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f7; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 15px; }
        button, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; }
        button { background: #007aff; color: white; border: none; font-weight: bold; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #debug { background: #1c1c1e; color: #32d74b; padding: 10px; height: 350px; overflow-y: auto; font-family: monospace; font-size: 12px; border-radius: 5px; border: 1px solid #333; }
        .status-ok { color: #32d74b; }
        .status-err { color: #ff453a; font-weight: bold; }
    </style>
</head>
<body>
    <div class="card">
        <button id="btnConnect" onclick="connectBLE()">1. Connect to ESP32</button>
    </div>

    <div class="card">
        <label>Select Station Folder:</label>
        <select id="folderSel" onchange="fetchFiles()"><option value="">-- Select Folder --</option></select>
        <div id="fileCheck" style="margin: 10px 0; font-size: 13px;"></div>
        
        <button id="btnTransfer" disabled onclick="doFullTransfer()">2. Transfer All to ESP32</button>
        <button id="btnModem" disabled onclick="doFullModemWrite()" style="background:#28a745">3. Write All to Modem</button>
    </div>

    <div id="debug">Log: Initializing...</div>

<script>
    let bleChar, bleResponse, driveData;
    const S_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
    const C_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
    const scriptUrl = "https://script.google.com/macros/s/AKfycbzvAinYxfH2FNcAOWUXedNnKyIR-f2rKToYzLOF4d5J-5HhN9FOy4rLmHQ2w92Mr7EK/exec"; // PASTE YOUR /exec URL HERE

    const requiredFiles = ["root_ca.pem", "client_cert.pem", "client_key.pem"];

    function log(m, isErr=false) { 
        const d = document.getElementById('debug'); 
        d.innerHTML += `<div class="${isErr?'status-err':''}">> ${m}</div>`; 
        d.scrollTop = d.scrollHeight; 
    }

    async function connectBLE() {
        try {
            const dev = await navigator.bluetooth.requestDevice({filters:[{services:[S_UUID]}]});
            const gatt = await dev.gatt.connect();
            const svc = await gatt.getPrimaryService(S_UUID);
            bleChar = await svc.getCharacteristic(C_UUID);
            await bleChar.startNotifications();
            bleChar.oncharacteristicvaluechanged = (e) => {
                bleResponse = new TextDecoder().decode(e.target.value);
            };
            log("Connected to ESP32 ✅");
            document.getElementById('btnConnect').innerText = "Connected";
        } catch(e) { log("BLE Error: " + e, true); }
    }

    async function fetchFiles() {
        const id = document.getElementById('folderSel').value;
        if(!id) return;
        log("Fetching folder contents...");
        try {
            const resp = await fetch(`${scriptUrl}?action=getCerts&id=${id}`);
            driveData = await resp.json();
            
            let html = "<b>Required Files Check:</b><br>";
            let allPresent = true;

            requiredFiles.forEach(file => {
                if (driveData[file]) {
                    html += `<span class="status-ok">✅ ${file}</span><br>`;
                } else {
                    html += `<span class="status-err">❌ ${file} (Missing)</span><br>`;
                    allPresent = false;
                }
            });

            document.getElementById('fileCheck').innerHTML = html;
            document.getElementById('btnTransfer').disabled = !allPresent;
            
            if(allPresent) log("All Azure IoT files found. Ready for Transfer.");
        } catch(e) { log("Fetch failed. Check Apps Script URL.", true); }
    }

    // BUTTON 2: Transfer all in order
    async function doFullTransfer() {
        log("<b>Starting Transfer to ESP32 Flash...</b>");
        try {
            for (const fileName of requiredFiles) {
                log(`Transferring: ${fileName}`);
                const raw = atob(driveData[fileName].data);
                
                // Start
                bleResponse = null;
                await bleChar.writeValue(new TextEncoder().encode("S" + fileName));
                while(bleResponse !== "ACK_S") await new Promise(r => setTimeout(r, 50));

                // Chunked Data (150 bytes per BLE packet)
                const chunkSize = 150;
                for (let i = 0; i < raw.length; i += chunkSize) {
                    const chunk = raw.slice(i, i + chunkSize);
                    bleResponse = null;
                    await bleChar.writeValue(new TextEncoder().encode("D" + chunk));
                    while(bleResponse !== "ACK_D") await new Promise(r => setTimeout(r, 20));
                }

                // End
                bleResponse = null;
                await bleChar.writeValue(new TextEncoder().encode("E"));
                while(bleResponse !== "FS_READY") await new Promise(r => setTimeout(r, 50));
                log(`${fileName} saved to ESP32 ✅`);
            }
            log("<b>Transfer Complete.</b>");
            document.getElementById('btnModem').disabled = false;
        } catch (e) { log("Transfer Error: " + e, true); }
    }

    // BUTTON 3: Write all to Modem in order
    async function doFullModemWrite() {
        log("<b>Starting Write to BC660K Modem...</b>");
        try {
            for (const fileName of requiredFiles) {
                log(`Provisioning: ${fileName}`);
                bleResponse = null;
                await bleChar.writeValue(new TextEncoder().encode("W" + fileName));
                
                let timeout = 0;
                while(bleResponse !== "MODEM_OK") {
                    await new Promise(r => setTimeout(r, 250));
                    if(bleResponse === "MODEM_FAIL") throw new Error("Modem rejected " + fileName);
                    if(timeout++ > 120) throw new Error("Timeout waiting for modem response for " + fileName);
                }
                log(`${fileName} written to modem slot ✅`);
            }
            log("<span class='status-ok'><b>ALL CERTIFICATES PROVISIONED SUCCESSFULLY!</b></span>");
        } catch (e) { log("Modem Write Error: " + e, true); }
    }

    window.onload = async () => {
        try {
            const resp = await fetch(`${scriptUrl}?action=listAllFolders`);
            const folders = await resp.json();
            const sel = document.getElementById('folderSel');
            folders.forEach(f => sel.innerHTML += `<option value="${f.id}">${f.name}</option>`);
            log("Stations loaded from Drive.");
        } catch(e) { log("Google Drive connection failed.", true); }
    };
</script>
</body>
</html>
