async function transferToFlash() {
    const id = document.getElementById('stationSelect').value;
    log("Fetching files from Drive...");
    const resp = await fetch(document.getElementById('scriptUrl').value + `?action=getCerts&id=${id}`);
    const certs = await resp.json();
    
    // Exact filenames provided by you
    const targetFiles = ["root_ca.pem", "client_cert.pem", "client_key.pem"];

    for (let fileName of targetFiles) {
        const fileObj = certs[fileName];
        if(!fileObj) {
            log(`Error: ${fileName} not found in folder.`);
            continue;
        }

        const raw = atob(fileObj.data);
        log(`Transferring: ${fileName} (${raw.length} bytes)`);
        
        // S Command
        await bleChar.writeValue(new TextEncoder().encode("S" + fileName));
        await waitAck("ACK_S");

        // D Command
        const size = 150;
        for (let i = 0; i < raw.length; i += size) {
            await bleChar.writeValue(new TextEncoder().encode("D" + raw.slice(i, i + size)));
            await waitAck("ACK_D");
        }

        // E Command
        await bleChar.writeValue(new TextEncoder().encode("E"));
        await waitAck("FS_READY");
        log(`${fileName} transferred.`);
    }
    log("Step 1 Complete.");
    document.getElementById('btnModem').disabled = false;
}

async function writeToModem() {
    const targetFiles = ["root_ca.pem", "client_cert.pem", "client_key.pem"];
    for (let fileName of targetFiles) {
        log(`Modem: Writing ${fileName}...`);
        await bleChar.writeValue(new TextEncoder().encode("W" + fileName));
        await waitAck("MODEM_OK");
        log(`${fileName} Ready on Modem.`);
    }
    log("PROVISIONING FINISHED.");
}
