<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Cert Provisioner</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f0f2f5; color: #1c1e21; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h3 { margin-top: 0; color: #007aff; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        input, button { width: 100%; padding: 14px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; box-sizing: border-box; }
        button { background: #007aff; color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .status { padding: 12px; margin: 8px 0; border-radius: 6px; font-size: 14px; background: #f8f9fa; border-left: 4px solid #ccc; }
        .success { border-left-color: #28a745; background: #e9f7ef; color: #155724; }
        .active { border-left-color: #ffc107; background: #fffde7; }
        .folder-item { padding: 15px; border: 1px solid #eee; margin-top: 5px; border-radius: 8px; color: #007aff; cursor: pointer; background: #fff; display: block; text-align: left; }
        #debug { font-family: monospace; font-size: 11px; background: #222; color: #0f0; padding: 10px; border-radius: 5px; max-height: 150px; overflow-y: auto; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="card">
        <h3>1. Connectivity</h3>
        <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/AKfycbzwDuU25SSB6mh-VZ4X4rgTC9wMDzIYe7ROmTVpI42gRhtxTxorCHeZl9RNuW0ynxP7/exec">
        <button id="btnConnect" onclick="connectBLE()">Connect ESP32 Bluetooth</button>
        <p id="bleStatus" style="text-align:center; font-weight:bold;">BLE: Disconnected</p>
    </div>

    <div class="card">
        <h3>2. Directory Search</h3>
        <input type="text" id="searchQ" placeholder="Type folder name to search..." oninput="searchDrive()">
        <div id="results"></div>
    </div>

    <div class="card">
        <h3>3. Progress</h3>
        <div id="caStat" class="status">CA Cert: Waiting...</div>
        <div id="certStat" class="status">Client Cert: Waiting...</div>
        <div id="keyStat" class="status">Client Key: Waiting...</div>
        <button id="btnUpdate" disabled onclick="triggerModemUpdate()">Write to Modem Memory</button>
        <div id="debug">Log: Ready...</div>
    </div>

    <script>
        let bleChar;
        const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
        const CHAR_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";

        function log(msg) {
            const d = document.getElementById('debug');
            d.innerHTML += `<br>> ${msg}`;
            d.scrollTop = d.scrollHeight;
        }

        async function connectBLE() {
            try {
                log("Requesting device...");
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [SERVICE_UUID] }]
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                bleChar = await service.getCharacteristic(CHAR_UUID);
                
                document.getElementById('bleStatus').innerText = "BLE: Connected ‚úÖ";
                document.getElementById('bleStatus').style.color = "green";
                log("Connected to ESP32");
            } catch (e) { 
                log("Error: " + e);
                alert("Connection failed: " + e); 
            }
        }

        async function searchDrive() {
            const url = document.getElementById('scriptUrl').value;
            const q = document.getElementById('searchQ').value;
            const res = document.getElementById('results');
            
            if(!url) return;
            res.innerHTML = "<small>Searching...</small>";

            try {
                const fullUrl = `${url}?action=search&q=${encodeURIComponent(q)}`;
                const response = await fetch(fullUrl);
                const folders = await response.json();
                
                let html = '';
                if(folders.length === 0) html = '<small>No folders found.</small>';
                
                folders.forEach(f => {
                    html += `<div class="folder-item" onclick="loadCerts('${f.id}', '${f.name}')">üìÅ ${f.name}</div>`;
                });
                res.innerHTML = html;
            } catch (e) { log("Search error: " + e); }
        }

        async function loadCerts(id, name) {
            if(!bleChar) { alert("Connect BLE first!"); return; }
            const url = document.getElementById('scriptUrl').value;
            document.getElementById('results').innerHTML = `<b>Selected: ${name}</b>`;
            log("Fetching certificates...");

            try {
                const response = await fetch(`${url}?action=getCerts&id=${id}`);
                const certs = await response.json();

                if(certs.ca) await uploadToESP(certs.ca, "root_ca.pem", "caStat");
                if(certs.cert) await uploadToESP(certs.cert, "client_cert.pem", "certStat");
                if(certs.key) await uploadToESP(certs.key, "client_key.pem", "keyStat");

                document.getElementById('btnUpdate').disabled = false;
                log("All files transferred.");
            } catch (e) { log("Fetch error: " + e); }
        }

        async function uploadToESP(file, espName, statId) {
            const el = document.getElementById(statId);
            el.className = "status active";
            el.innerText = `Sending ${espName}...`;
            
            const raw = atob(file.data);
            log(`Uploading ${espName} (${raw.length} bytes)`);

            // Start command
            await bleChar.writeValue(new TextEncoder().encode("S" + espName));
            
            const size = 150;
            for (let i = 0; i < raw.length; i += size) {
                const chunk = "D" + raw.slice(i, i + size);
                await bleChar.writeValue(new TextEncoder().encode(chunk));
                await new Promise(r => setTimeout(r, 60)); // Buffer protection
            }
            
            // End command
            await bleChar.writeValue(new TextEncoder().encode("E"));
            el.className = "status success";
            el.innerText = `${espName}: Success ‚úÖ`;
        }

        async function triggerModemUpdate() {
            await bleChar.writeValue(new TextEncoder().encode("U"));
            log("Update triggered on ESP32.");
            alert("Modem update started!");
        }
    </script>
</body>
</html>
