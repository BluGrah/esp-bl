<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Cert Provisioner</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f4f7f9; color: #333; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h3 { margin-top: 0; color: #007aff; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        input, button { width: 100%; padding: 14px; margin: 10px 0; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; }
        button { background: #007aff; color: white; border: none; font-weight: bold; cursor: pointer; }
        button:disabled { background: #b0c4de; cursor: not-allowed; }
        .status { padding: 12px; margin: 8px 0; border-radius: 6px; font-size: 14px; background: #f8f9fa; border-left: 5px solid #ccc; transition: 0.3s; }
        .success { border-left-color: #28a745; background: #e9f7ef; color: #155724; }
        .uploading { border-left-color: #ffc107; background: #fffde7; }
        .folder-item { padding: 15px; border: 1px solid #e1e4e8; margin-top: 8px; border-radius: 8px; color: #007aff; cursor: pointer; background: #fff; font-weight: 500; }
        .folder-item:active { background: #f0f7ff; }
        #log { font-family: monospace; font-size: 12px; color: #666; max-height: 100px; overflow-y: auto; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="card">
        <h3>1. Authentication</h3>
        <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/AKfycbxCPfATWUqY84X-pPqoXIGPfCMNA3lBfKw29a81Lc5nPKWjgfX8Ft7jpXWG-bX2tDZ-/exec">
        <button id="connectBtn" onclick="connectBLE()">Connect ESP32 Bluetooth</button>
        <p id="bleStatus" style="text-align:center; font-weight:bold;">BLE: Disconnected</p>
    </div>

    <div class="card">
        <h3>2. Search Directories</h3>
        <input type="text" id="searchQ" placeholder="Type folder name (e.g. Device_01)..." oninput="searchDrive()">
        <div id="results"></div>
    </div>

    <div class="card">
        <h3>3. Transfer Progress</h3>
        <div id="caStat" class="status">CA Cert: Waiting...</div>
        <div id="certStat" class="status">Client Cert: Waiting...</div>
        <div id="keyStat" class="status">Client Key: Waiting...</div>
        <button id="modemBtn" disabled onclick="triggerUpdate()">4. Commit to Modem Memory</button>
        <div id="log"></div>
    </div>

    <script>
        let bleChar;
        const S_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
        const C_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";

        function log(msg) {
            const l = document.getElementById('log');
            l.innerHTML += `> ${msg}<br>`;
            l.scrollTop = l.scrollHeight;
        }

        async function connectBLE() {
            try {
                log("Requesting ESP32...");
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [S_UUID] }]
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(S_UUID);
                bleChar = await service.getCharacteristic(C_UUID);
                
                document.getElementById('bleStatus').innerText = "BLE: Connected ‚úÖ";
                document.getElementById('bleStatus').style.color = "green";
                log("Bluetooth Ready.");
            } catch (e) { 
                alert("Connect Error: " + e);
                log("BLE Failed: " + e);
            }
        }

        async function searchDrive() {
            const url = document.getElementById('scriptUrl').value;
            const q = document.getElementById('searchQ').value;
            const res = document.getElementById('results');
            
            if(q.length < 2) { res.innerHTML = ""; return; }
            if(!url) { res.innerHTML = "<small>Missing Script URL</small>"; return; }
            
            try {
                const resp = await fetch(`${url}?action=search&q=${encodeURIComponent(q)}`);
                const folders = await resp.json();
                
                let html = '';
                if(folders.length === 0) html = '<small>No matches found.</small>';
                folders.forEach(f => {
                    html += `<div class="folder-item" onclick="loadFolder('${f.id}', '${f.name}')">üìÅ ${f.name}</div>`;
                });
                res.innerHTML = html;
            } catch (e) { log("Search Error: " + e); }
        }

        async function loadFolder(id, name) {
            const url = document.getElementById('scriptUrl').value;
            document.getElementById('results').innerHTML = `<b>Selected: ${name}</b>`;
            log(`Fetching certs for ${name}...`);
            
            try {
                const resp = await fetch(`${url}?action=getCerts&id=${id}`);
                const certs = await resp.json();
                
                if(certs.ca) await uploadToESP(certs.ca, "root_ca.pem", "caStat");
                if(certs.cert) await uploadToESP(certs.cert, "client_cert.pem", "certStat");
                if(certs.key) await uploadToESP(certs.key, "client_key.pem", "keyStat");
                
                document.getElementById('modemBtn').disabled = false;
                log("All transfers complete.");
            } catch (e) { alert("Fetch Error: " + e); }
        }

        async function uploadToESP(file, espName, statId) {
            const el = document.getElementById(statId);
            el.className = "status uploading";
            el.innerText = `Uploading ${espName}...`;
            
            const data = atob(file.data);
            log(`Sending ${espName} (${data.length} bytes)`);
            
            // Header: Start
            await bleChar.writeValue(new TextEncoder().encode("S" + espName));
            
            const chunkSize = 150;
            for (let i = 0; i < data.length; i += chunkSize) {
                const chunk = "D" + data.slice(i, i + chunkSize);
                await bleChar.writeValue(new TextEncoder().encode(chunk));
                await new Promise(r => setTimeout(r, 65)); // Safety delay for ESP32 flash
            }
            
            // Header: End
            await bleChar.writeValue(new TextEncoder().encode("E"));
            
            el.className = "status success";
            el.innerText = `${espName}: Uploaded ‚úÖ`;
        }

        async function triggerUpdate() {
            log("Triggering modem update...");
            await bleChar.writeValue(new TextEncoder().encode("U"));
            alert("Modem update sequence started! Check ESP32 Serial Monitor.");
        }
    </script>
</body>
</html>
