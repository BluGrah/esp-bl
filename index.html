<!DOCTYPE html>
<html>
<head>
    <title>BC660K Provisioner v3.0</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f7; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 15px; }
        button, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; }
        button { background: #007aff; color: white; border: none; font-weight: bold; cursor: pointer; }
        button:disabled { background: #ccc; }
        #debug { background: #1c1c1e; color: #32d74b; padding: 10px; height: 250px; overflow-y: auto; font-family: monospace; font-size: 12px; border-radius: 5px; }
        .err { color: #ff453a; }
    </style>
</head>
<body>
    <div class="card">
        <button id="btnConnect" onclick="connectBLE()">1. Connect Bluetooth</button>
    </div>
    <div class="card">
        <label>Select Station Folder:</label>
        <select id="folderSel" onchange="fetchFiles()"><option value="">-- Loading --</option></select>
        
        <label>Select Certificate File:</label>
        <select id="fileSel" disabled><option>Select folder first</option></select>
        
        <button id="btnTransfer" disabled onclick="doTransfer()">2. Upload to ESP Flash</button>
        <button id="btnModem" disabled onclick="doModem()" style="background:#28a745">3. Provision to BC660K</button>
    </div>
    <div id="debug">Log: Initializing...</div>

<script>
    let bleChar, bleResponse, driveData;
    const S_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
    const C_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
    const scriptUrl = "YOUR_APPS_SCRIPT_URL_HERE"; 

    function log(m, isErr=false) { 
        const d = document.getElementById('debug'); 
        d.innerHTML += `<div class="${isErr?'err':''}">> ${m}</div>`; 
        d.scrollTop = d.scrollHeight; 
    }

    async function connectBLE() {
        try {
            log("Requesting Device...");
            const dev = await navigator.bluetooth.requestDevice({filters:[{services:[S_UUID]}]});
            const gatt = await dev.gatt.connect();
            const svc = await gatt.getPrimaryService(S_UUID);
            bleChar = await svc.getCharacteristic(C_UUID);
            await bleChar.startNotifications();
            bleChar.oncharacteristicvaluechanged = (e) => {
                bleResponse = new TextDecoder().decode(e.target.value);
                console.log("BLE Notify:", bleResponse);
            };
            log("Connected to ESP32 ✅");
            document.getElementById('btnConnect').innerText = "Connected: " + dev.name;
        } catch(e) { log("BLE Error: " + e, true); }
    }

    async function fetchFiles() {
        const id = document.getElementById('folderSel').value;
        if(!id) return;
        log("Fetching Drive files...");
        const resp = await fetch(`${scriptUrl}?action=getCerts&id=${id}`);
        driveData = await resp.json();
        const sel = document.getElementById('fileSel');
        sel.innerHTML = '<option value="">-- Choose File --</option>';
        Object.keys(driveData).forEach(name => sel.innerHTML += `<option value="${name}">${name}</option>`);
        sel.disabled = false;
        document.getElementById('btnTransfer').disabled = false;
        log("Files ready.");
    }

    async function doTransfer() {
        const name = document.getElementById('fileSel').value;
        const raw = atob(driveData[name].data);
        log(`Starting transfer: ${name}...`);
        
        bleResponse = null;
        await bleChar.writeValue(new TextEncoder().encode("S" + name));
        while(bleResponse !== "ACK_S") await new Promise(r => setTimeout(r, 50));

        const size = 150;
        for (let i = 0; i < raw.length; i += size) {
            bleResponse = null;
            await bleChar.writeValue(new TextEncoder().encode("D" + raw.slice(i, i + size)));
            while(bleResponse !== "ACK_D") await new Promise(r => setTimeout(r, 20));
        }
        
        bleResponse = null;
        await bleChar.writeValue(new TextEncoder().encode("E"));
        while(bleResponse !== "FS_READY") await new Promise(r => setTimeout(r, 50));
        
        log("File saved to ESP LittleFS ✅");
        document.getElementById('btnModem').disabled = false;
    }

    async function doModem() {
    // 1. Immediate feedback to prove the button works
    console.log("Button clicked: doModem"); 
    log("UI: 'Provision' button pressed.");

    const sel = document.getElementById('fileSel');
    const name = sel.value;

    if(!name) {
        log("UI Error: No file selected in dropdown.", true);
        return;
    }
    
    if(!bleChar) {
        log("UI Error: Bluetooth not connected.", true);
        return;
    }

    try {
        log(`BLE: Sending command 'W${name}'...`);
        bleResponse = null;
        
        // Convert string to Uint8Array for maximum compatibility
        const encoder = new TextEncoder();
        const data = encoder.encode("W" + name);
        
        await bleChar.writeValue(data);
        log("BLE: Data sent to ESP32. Waiting for Modem response...");
        
        // Wait for notification
        let attempts = 0;
        while(bleResponse !== "MODEM_OK" && bleResponse !== "MODEM_FAIL") {
            await new Promise(r => setTimeout(r, 200));
            attempts++;
            if(attempts > 100) { // 20 second timeout
                log("Timeout: No response from ESP32.", true);
                break;
            }
        }
        
        if(bleResponse === "MODEM_OK") {
            log("SUCCESS: Modem accepted certificate! ✅");
        } else if(bleResponse === "MODEM_FAIL") {
            log("FAIL: Modem rejected certificate. Check ESP Serial.", true);
        }
    } catch(e) {
        log("JS Error: " + e.message, true);
        console.error(e);
    }
}

    window.onload = async () => {
        try {
            const resp = await fetch(`${scriptUrl}?action=listAllFolders`);
            const folders = await resp.json();
            const sel = document.getElementById('folderSel');
            sel.innerHTML = '<option value="">-- Select Folder --</option>';
            folders.forEach(f => sel.innerHTML += `<option value="${f.id}">${f.name}</option>`);
            log("Stations loaded from Drive.");
        } catch(e) { log("Google Drive Error: Check URL/Permissions.", true); }
    };
</script>
</body>
</html>
